import { merge } from "../core/utils/object.ts";
import { posix } from "../deps/path.ts";
import { Page } from "../core/file.ts";
import { pagefind } from "../deps/pagefind.ts";
export const defaults = {
  outputPath: "/pagefind",
  ui: {
    containerId: "search",
    showImages: false,
    excerptLength: 0,
    showEmptyFilters: true,
    showSubResults: false,
    resetStyles: true
  },
  indexing: {
    rootSelector: "html",
    verbose: false,
    excludeSelectors: []
  }
};
/** A plugin to generate a static full text search engine */ export default function(userOptions) {
  const options = merge(defaults, userOptions);
  return (site)=>{
    site.process([
      ".html"
    ], async (pages, allPages)=>{
      const { index } = await pagefind.createIndex(options.indexing);
      if (!index) {
        throw new Error("Pagefind index not created");
      }
      // Page indexing
      for (const page of pages){
        const { errors } = await index.addHTMLFile({
          url: page.data.url,
          content: page.content
        });
        if (errors.length > 0) {
          throw new Error(`Pagefind index errors for ${page.src.path}:\n${errors.join("\n")}`);
        }
      }
      if (options.customRecords) {
        for (const record of options.customRecords){
          const { errors } = await index.addCustomRecord(record);
          if (errors.length > 0) {
            throw new Error(`Pagefind index errors for custom record:\n${errors.join("\n")}`);
          }
        }
      }
      // Output indexing
      const { files } = await index.getFiles();
      const textDecoder = new TextDecoder();
      const textExtensions = [
        ".js",
        ".css",
        ".json"
      ];
      for (const file of files){
        const { path } = file;
        const content = textExtensions.includes(posix.extname(path)) ? textDecoder.decode(file.content) : file.content;
        allPages.push(Page.create({
          url: posix.join("/", options.outputPath, path),
          content
        }));
      }
      // Cleanup
      await index.deleteIndex();
      await pagefind.close();
    });
    if (options.ui) {
      const { containerId, ...ui } = options.ui;
      site.process([
        ".html"
      ], (pages)=>{
        for (const page of pages){
          const { document } = page;
          if (!document) {
            continue;
          }
          const container = document.getElementById(containerId);
          // Insert UI styles and scripts
          if (container) {
            const styles = document.createElement("link");
            styles.setAttribute("rel", "stylesheet");
            styles.setAttribute("href", site.url(`${posix.join(options.outputPath, "pagefind-ui.css")}`));
            // Insert before other styles to allow overriding
            const first = document.head.querySelector("link[rel=stylesheet],style");
            if (first) {
              document.head.insertBefore(styles, first);
            } else {
              document.head.append(styles);
            }
            const script = document.createElement("script");
            script.setAttribute("type", "text/javascript");
            script.setAttribute("src", site.url(`${posix.join(options.outputPath, "pagefind-ui.js")}`));
            document.head.append(script);
            const uiSettings = {
              element: `#${containerId}`,
              ...ui,
              bundlePath: site.url(posix.join(options.outputPath, "/")),
              baseUrl: site.url("/"),
              processTerm: ui.processTerm ? ui.processTerm.toString() : undefined,
              processResult: ui.processResult ? ui.processResult.toString() : undefined
            };
            const init = document.createElement("script");
            init.setAttribute("type", "text/javascript");
            init.innerHTML = `window.addEventListener('DOMContentLoaded',()=>{new PagefindUI(${JSON.stringify(uiSettings)});});`;
            document.head.append(init);
            if (ui.highlightParam) {
              const highlightScript = document.createElement("script");
              highlightScript.setAttribute("type", "module");
              highlightScript.innerHTML = `
              import "${site.url(`${posix.join(options.outputPath, "pagefind-highlight.js")}`)}";
              new PagefindHighlight({ highlightParam: ${JSON.stringify(ui.highlightParam)} });
              `;
              document.head.append(highlightScript);
            }
          }
        }
      });
    }
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvbHVtZUB2Mi4yLjAvcGx1Z2lucy9wYWdlZmluZC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtZXJnZSB9IGZyb20gXCIuLi9jb3JlL3V0aWxzL29iamVjdC50c1wiO1xuaW1wb3J0IHsgcG9zaXggfSBmcm9tIFwiLi4vZGVwcy9wYXRoLnRzXCI7XG5pbXBvcnQgeyBQYWdlIH0gZnJvbSBcIi4uL2NvcmUvZmlsZS50c1wiO1xuaW1wb3J0IHsgcGFnZWZpbmQgfSBmcm9tIFwiLi4vZGVwcy9wYWdlZmluZC50c1wiO1xuXG5pbXBvcnQgdHlwZSB7IEN1c3RvbVJlY29yZCwgVHJhbnNsYXRpb25zT3B0aW9ucyB9IGZyb20gXCIuLi9kZXBzL3BhZ2VmaW5kLnRzXCI7XG5pbXBvcnQgdHlwZSBTaXRlIGZyb20gXCIuLi9jb3JlL3NpdGUudHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBVSU9wdGlvbnMge1xuICAvKipcbiAgICogVGhlIGNvbnRhaW5lciBpZCB0byBpbnNlcnQgdGhlIHNlYXJjaFxuICAgKiBAZGVmYXVsdCBcInNlYXJjaFwiXG4gICAqL1xuICBjb250YWluZXJJZD86IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIG51bWJlciBvZiBzZWFyY2ggcmVzdWx0cyB0byBsb2FkIGF0IG9uY2UsIGJlZm9yZSBhIOKAnExvYWQgbW9yZeKAnSBidXR0b24gaXMgc2hvd24uXG4gICAqIEBkZWZhdWx0IDVcbiAgICovXG4gIHBhZ2VTaXplPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBJbmNsdWRlIHJlc3VsdHMgZnJvbSBwYWdlIHN1YnNlY3Rpb25zIChiYXNlZCBvbiBoZWFkaW5ncyB3aXRoIElEcykuXG4gICAqL1xuICBzaG93U3ViUmVzdWx0cz86IGJvb2xlYW47XG5cbiAgLyoqIFdoZXRoZXIgdG8gc2hvdyBhbiBpbWFnZSBhbG9uZ3NpZGUgZWFjaCBzZWFyY2ggcmVzdWx0LiAqL1xuICBzaG93SW1hZ2VzPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIGNoYXJhY3RlcnMgdG8gc2hvdyBpbiB0aGUgZXhjZXJwdC5cbiAgICogYDBgIG1lYW5zIG5vIGxpbWl0XG4gICAqL1xuICBleGNlcnB0TGVuZ3RoPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBBIGZ1bmN0aW9uIHRoYXQgUGFnZWZpbmQgVUkgY2FsbHMgYmVmb3JlIHBlcmZvcm1pbmcgYSBzZWFyY2guXG4gICAqIFRoaXMgY2FuIGJlIHVzZWQgdG8gbm9ybWFsaXplIHNlYXJjaCB0ZXJtcyB0byBtYXRjaCB5b3VyIGNvbnRlbnQuXG4gICAqL1xuICBwcm9jZXNzVGVybT86ICh0ZXJtOiBzdHJpbmcpID0+IHN0cmluZztcblxuICAvKipcbiAgICogQSBmdW5jdGlvbiB0aGF0IFBhZ2VmaW5kIFVJIGNhbGxzIGJlZm9yZSBkaXNwbGF5aW5nIGVhY2ggcmVzdWx0LlxuICAgKiBUaGlzIGNhbiBiZSB1c2VkIHRvIGZpeCByZWxhdGl2ZSBVUkxzLCByZXdyaXRlIHRpdGxlcyxcbiAgICogb3IgYW55IG90aGVyIG1vZGlmaWNhdGlvbnMgeW91IG1pZ2h0IGxpa2UgdG8gbWFrZSB0byB0aGUgcmF3IHJlc3VsdCBvYmplY3RcbiAgICogcmV0dXJuZWQgYnkgUGFnZWZpbmRcbiAgICovXG4gIHByb2Nlc3NSZXN1bHQ/OiAocmVzdWx0OiB1bmtub3duKSA9PiB1bmtub3duO1xuXG4gIC8qKlxuICAgKiBCeSBkZWZhdWx0LCBQYWdlZmluZCBVSSBzaG93cyBmaWx0ZXJzIHdpdGggbm8gcmVzdWx0cyBhbG9uZ3NpZGUgdGhlIGNvdW50ICgwKS5cbiAgICogUGFzcyBmYWxzZSB0byBoaWRlIGZpbHRlcnMgdGhhdCBoYXZlIG5vIHJlbWFpbmluZyByZXN1bHRzLlxuICAgKi9cbiAgc2hvd0VtcHR5RmlsdGVycz86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBmaWx0ZXIgZGlzcGxheSBpcyB0byBzaG93IHZhbHVlcyBvbmx5IHdoZW4gdGhlcmUgaXMgb25lIGZpbHRlciB3aXRoIHNpeCBvciBmZXdlciB2YWx1ZXMuIFdoZW4geW91IGluY2x1ZGUgYSBmaWx0ZXIgbmFtZSBpbiBvcGVuRmlsdGVycyBpdCB3aWxsIG9wZW4gYnkgZGVmYXVsdCwgcmVnYXJkbGVzcyBvZiB0aGUgbnVtYmVyIG9mIGZpbHRlcnMgb3IgdmFsdWVzIHByZXNlbnQuXG4gICAqL1xuICBvcGVuRmlsdGVycz86IHN0cmluZ1tdO1xuXG4gIC8qKlxuICAgKiBCeSBkZWZhdWx0LCBQYWdlZmluZCBVSSBhcHBsaWVzIGEgQ1NTIHJlc2V0IHRvIGl0c2VsZi5cbiAgICogUGFzcyBmYWxzZSB0byBvbWl0IHRoaXMgYW5kIGluaGVyaXQgZnJvbSB5b3VyIHNpdGUgc3R5bGVzLlxuICAgKi9cbiAgcmVzZXRTdHlsZXM/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IGFmdGVyIGEgdXNlciBzdG9wcyB0eXBpbmcgYmVmb3JlIHBlcmZvcm1pbmcgYSBzZWFyY2guXG4gICAqIElmIHlvdSB3aXNoIHRvIGRpc2FibGUgdGhpcywgc2V0IHRvIDAuXG4gICAqIEBkZWZhdWx0IDMwMFxuICAgKi9cbiAgZGVib3VuY2VUaW1lb3V0TXM/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEEgc2V0IG9mIGN1c3RvbSB1aSBzdHJpbmdzIHRvIHVzZSBpbnN0ZWFkIG9mIHRoZSBhdXRvbWF0aWNhbGx5IGRldGVjdGVkIGxhbmd1YWdlIHN0cmluZ3MuXG4gICAqIFNlZSBodHRwczovL2dpdGh1Yi5jb20vQ2xvdWRDYW5ub24vcGFnZWZpbmQvYmxvYi9tYWluL3BhZ2VmaW5kX3VpL3RyYW5zbGF0aW9ucy9lbi5qc29uIGZvciBhbGwgYXZhaWxhYmxlIGtleXMgYW5kIGluaXRpYWwgdmFsdWVzLlxuICAgKiBUaGUgaXRlbXMgaW4gc3F1YXJlIGJyYWNrZXRzIHN1Y2ggYXMgU0VBUkNIX1RFUk0gd2lsbCBiZSBzdWJzdGl0dXRlZCBkeW5hbWljYWxseSB3aGVuIHRoZSB0ZXh0IGlzIHVzZWQuXG4gICAqL1xuICB0cmFuc2xhdGlvbnM/OiBUcmFuc2xhdGlvbnNPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBFbmFibGluZyBhdXRvZm9jdXMgYXV0b21hdGljYWxseSBkaXJlY3RzIGF0dGVudGlvbiB0byB0aGUgc2VhcmNoIGlucHV0IGZpZWxkIGZvclxuICAgKiBlbmhhbmNlZCB1c2VyIGNvbnZlbmllbmNlLCBwYXJ0aWN1bGFybHkgYmVuZWZpY2lhbCB3aGVuIHRoZSBVSSBpcyBsb2FkZWQgd2l0aGluIGEgbW9kYWwgZGlhbG9nLlxuICAgKiBIb3dldmVyLCBleGVyY2lzZSBjYXV0aW9uLCBhcyB1c2luZyBhdXRvZm9jdXMgaW5kaXNjcmltaW5hdGVseSBtYXkgcG9zZSBwb3RlbnRpYWxcbiAgICogYWNjZXNzaWJpbGl0eSBjaGFsbGVuZ2VzLlxuICAgKi9cbiAgYXV0b2ZvY3VzPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogUGFzc2VzIHNvcnQgb3B0aW9ucyB0byBQYWdlZmluZCBmb3IgcmFua2luZy5cbiAgICogTm90ZSB0aGF0IHVzaW5nIGEgc29ydCB3aWxsIG92ZXJyaWRlIGFsbCByYW5raW5nIGJ5IHJlbGV2YW5jZS5cbiAgICovXG4gIHNvcnQ/OiBSZWNvcmQ8c3RyaW5nLCBcImFzY1wiIHwgXCJkZXNjXCI+O1xuXG4gIC8qKlxuICAgKiBFbmFibGUgdGhlIGFiaWxpdHkgdG8gaGlnaGxpZ2h0IHNlYXJjaCB0ZXJtcyBvbiB0aGUgcmVzdWx0IHBhZ2VzLlxuICAgKiBDb25maWd1cmUgdGhlIHF1ZXJ5IHBhcmFtZXRlciBuYW1lLlxuICAgKi9cbiAgaGlnaGxpZ2h0UGFyYW0/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XG4gIC8qKiBUaGUgcGF0aCB0byB0aGUgcGFnZWZpbmQgYnVuZGxlIGRpcmVjdG9yeSAqL1xuICBvdXRwdXRQYXRoPzogc3RyaW5nO1xuXG4gIC8qKiBPcHRpb25zIGZvciB0aGUgVUkgaW50ZXJmYWNlIG9yIGZhbHNlIHRvIGRpc2FibGUgaXQgKi9cbiAgdWk/OiBVSU9wdGlvbnMgfCBmYWxzZTtcblxuICAvKiogT3B0aW9ucyBmb3IgdGhlIGluZGV4aW5nIHByb2Nlc3MgKi9cbiAgaW5kZXhpbmc/OiBwYWdlZmluZC5QYWdlZmluZFNlcnZpY2VDb25maWc7XG5cbiAgLyoqIE90aGVyIGN1c3RvbSByZWNvcmRzICovXG4gIGN1c3RvbVJlY29yZHM/OiBDdXN0b21SZWNvcmRbXTtcbn1cblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRzOiBPcHRpb25zID0ge1xuICBvdXRwdXRQYXRoOiBcIi9wYWdlZmluZFwiLFxuICB1aToge1xuICAgIGNvbnRhaW5lcklkOiBcInNlYXJjaFwiLFxuICAgIHNob3dJbWFnZXM6IGZhbHNlLFxuICAgIGV4Y2VycHRMZW5ndGg6IDAsXG4gICAgc2hvd0VtcHR5RmlsdGVyczogdHJ1ZSxcbiAgICBzaG93U3ViUmVzdWx0czogZmFsc2UsXG4gICAgcmVzZXRTdHlsZXM6IHRydWUsXG4gIH0sXG4gIGluZGV4aW5nOiB7XG4gICAgcm9vdFNlbGVjdG9yOiBcImh0bWxcIixcbiAgICB2ZXJib3NlOiBmYWxzZSxcbiAgICBleGNsdWRlU2VsZWN0b3JzOiBbXSxcbiAgfSxcbn07XG5cbi8qKiBBIHBsdWdpbiB0byBnZW5lcmF0ZSBhIHN0YXRpYyBmdWxsIHRleHQgc2VhcmNoIGVuZ2luZSAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKHVzZXJPcHRpb25zPzogT3B0aW9ucykge1xuICBjb25zdCBvcHRpb25zID0gbWVyZ2UoZGVmYXVsdHMsIHVzZXJPcHRpb25zKTtcblxuICByZXR1cm4gKHNpdGU6IFNpdGUpID0+IHtcbiAgICBzaXRlLnByb2Nlc3MoW1wiLmh0bWxcIl0sIGFzeW5jIChwYWdlcywgYWxsUGFnZXMpID0+IHtcbiAgICAgIGNvbnN0IHsgaW5kZXggfSA9IGF3YWl0IHBhZ2VmaW5kLmNyZWF0ZUluZGV4KG9wdGlvbnMuaW5kZXhpbmcpO1xuXG4gICAgICBpZiAoIWluZGV4KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhZ2VmaW5kIGluZGV4IG5vdCBjcmVhdGVkXCIpO1xuICAgICAgfVxuXG4gICAgICAvLyBQYWdlIGluZGV4aW5nXG4gICAgICBmb3IgKGNvbnN0IHBhZ2Ugb2YgcGFnZXMpIHtcbiAgICAgICAgY29uc3QgeyBlcnJvcnMgfSA9IGF3YWl0IGluZGV4LmFkZEhUTUxGaWxlKHtcbiAgICAgICAgICB1cmw6IHBhZ2UuZGF0YS51cmwsXG4gICAgICAgICAgY29udGVudDogcGFnZS5jb250ZW50IGFzIHN0cmluZyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYFBhZ2VmaW5kIGluZGV4IGVycm9ycyBmb3IgJHtwYWdlLnNyYy5wYXRofTpcXG4ke2Vycm9ycy5qb2luKFwiXFxuXCIpfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAob3B0aW9ucy5jdXN0b21SZWNvcmRzKSB7XG4gICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIG9wdGlvbnMuY3VzdG9tUmVjb3Jkcykge1xuICAgICAgICAgIGNvbnN0IHsgZXJyb3JzIH0gPSBhd2FpdCBpbmRleC5hZGRDdXN0b21SZWNvcmQocmVjb3JkKTtcblxuICAgICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICBgUGFnZWZpbmQgaW5kZXggZXJyb3JzIGZvciBjdXN0b20gcmVjb3JkOlxcbiR7ZXJyb3JzLmpvaW4oXCJcXG5cIil9YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIE91dHB1dCBpbmRleGluZ1xuICAgICAgY29uc3QgeyBmaWxlcyB9ID0gYXdhaXQgaW5kZXguZ2V0RmlsZXMoKTtcbiAgICAgIGNvbnN0IHRleHREZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG4gICAgICBjb25zdCB0ZXh0RXh0ZW5zaW9ucyA9IFtcIi5qc1wiLCBcIi5jc3NcIiwgXCIuanNvblwiXTtcblxuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgIGNvbnN0IHsgcGF0aCB9ID0gZmlsZTtcbiAgICAgICAgY29uc3QgY29udGVudCA9IHRleHRFeHRlbnNpb25zLmluY2x1ZGVzKHBvc2l4LmV4dG5hbWUocGF0aCkpXG4gICAgICAgICAgPyB0ZXh0RGVjb2Rlci5kZWNvZGUoZmlsZS5jb250ZW50KVxuICAgICAgICAgIDogZmlsZS5jb250ZW50O1xuXG4gICAgICAgIGFsbFBhZ2VzLnB1c2goXG4gICAgICAgICAgUGFnZS5jcmVhdGUoe1xuICAgICAgICAgICAgdXJsOiBwb3NpeC5qb2luKFwiL1wiLCBvcHRpb25zLm91dHB1dFBhdGgsIHBhdGgpLFxuICAgICAgICAgICAgY29udGVudCxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2xlYW51cFxuICAgICAgYXdhaXQgaW5kZXguZGVsZXRlSW5kZXgoKTtcbiAgICAgIGF3YWl0IHBhZ2VmaW5kLmNsb3NlKCk7XG4gICAgfSk7XG5cbiAgICBpZiAob3B0aW9ucy51aSkge1xuICAgICAgY29uc3QgeyBjb250YWluZXJJZCwgLi4udWkgfSA9IG9wdGlvbnMudWk7XG5cbiAgICAgIHNpdGUucHJvY2VzcyhbXCIuaHRtbFwiXSwgKHBhZ2VzKSA9PiB7XG4gICAgICAgIGZvciAoY29uc3QgcGFnZSBvZiBwYWdlcykge1xuICAgICAgICAgIGNvbnN0IHsgZG9jdW1lbnQgfSA9IHBhZ2U7XG4gICAgICAgICAgaWYgKCFkb2N1bWVudCkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkISk7XG5cbiAgICAgICAgICAvLyBJbnNlcnQgVUkgc3R5bGVzIGFuZCBzY3JpcHRzXG4gICAgICAgICAgaWYgKGNvbnRhaW5lcikge1xuICAgICAgICAgICAgY29uc3Qgc3R5bGVzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImxpbmtcIik7XG4gICAgICAgICAgICBzdHlsZXMuc2V0QXR0cmlidXRlKFwicmVsXCIsIFwic3R5bGVzaGVldFwiKTtcbiAgICAgICAgICAgIHN0eWxlcy5zZXRBdHRyaWJ1dGUoXG4gICAgICAgICAgICAgIFwiaHJlZlwiLFxuICAgICAgICAgICAgICBzaXRlLnVybChcbiAgICAgICAgICAgICAgICBgJHtwb3NpeC5qb2luKG9wdGlvbnMub3V0cHV0UGF0aCwgXCJwYWdlZmluZC11aS5jc3NcIil9YCxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIC8vIEluc2VydCBiZWZvcmUgb3RoZXIgc3R5bGVzIHRvIGFsbG93IG92ZXJyaWRpbmdcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0ID0gZG9jdW1lbnQuaGVhZC5xdWVyeVNlbGVjdG9yKFxuICAgICAgICAgICAgICBcImxpbmtbcmVsPXN0eWxlc2hlZXRdLHN0eWxlXCIsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKGZpcnN0KSB7XG4gICAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuaW5zZXJ0QmVmb3JlKHN0eWxlcywgZmlyc3QpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmQoc3R5bGVzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNjcmlwdFwiKTtcbiAgICAgICAgICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoXCJ0eXBlXCIsIFwidGV4dC9qYXZhc2NyaXB0XCIpO1xuICAgICAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZShcbiAgICAgICAgICAgICAgXCJzcmNcIixcbiAgICAgICAgICAgICAgc2l0ZS51cmwoXG4gICAgICAgICAgICAgICAgYCR7cG9zaXguam9pbihvcHRpb25zLm91dHB1dFBhdGgsIFwicGFnZWZpbmQtdWkuanNcIil9YCxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZChzY3JpcHQpO1xuXG4gICAgICAgICAgICBjb25zdCB1aVNldHRpbmdzID0ge1xuICAgICAgICAgICAgICBlbGVtZW50OiBgIyR7Y29udGFpbmVySWR9YCxcbiAgICAgICAgICAgICAgLi4udWksXG4gICAgICAgICAgICAgIGJ1bmRsZVBhdGg6IHNpdGUudXJsKHBvc2l4LmpvaW4ob3B0aW9ucy5vdXRwdXRQYXRoLCBcIi9cIikpLFxuICAgICAgICAgICAgICBiYXNlVXJsOiBzaXRlLnVybChcIi9cIiksXG4gICAgICAgICAgICAgIHByb2Nlc3NUZXJtOiB1aS5wcm9jZXNzVGVybVxuICAgICAgICAgICAgICAgID8gdWkucHJvY2Vzc1Rlcm0udG9TdHJpbmcoKVxuICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICBwcm9jZXNzUmVzdWx0OiB1aS5wcm9jZXNzUmVzdWx0XG4gICAgICAgICAgICAgICAgPyB1aS5wcm9jZXNzUmVzdWx0LnRvU3RyaW5nKClcbiAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBpbml0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNjcmlwdFwiKTtcbiAgICAgICAgICAgIGluaXQuc2V0QXR0cmlidXRlKFwidHlwZVwiLCBcInRleHQvamF2YXNjcmlwdFwiKTtcbiAgICAgICAgICAgIGluaXQuaW5uZXJIVE1MID1cbiAgICAgICAgICAgICAgYHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywoKT0+e25ldyBQYWdlZmluZFVJKCR7XG4gICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodWlTZXR0aW5ncylcbiAgICAgICAgICAgICAgfSk7fSk7YDtcbiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kKGluaXQpO1xuXG4gICAgICAgICAgICBpZiAodWkuaGlnaGxpZ2h0UGFyYW0pIHtcbiAgICAgICAgICAgICAgY29uc3QgaGlnaGxpZ2h0U2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNjcmlwdFwiKTtcbiAgICAgICAgICAgICAgaGlnaGxpZ2h0U2NyaXB0LnNldEF0dHJpYnV0ZShcInR5cGVcIiwgXCJtb2R1bGVcIik7XG4gICAgICAgICAgICAgIGhpZ2hsaWdodFNjcmlwdC5pbm5lckhUTUwgPSBgXG4gICAgICAgICAgICAgIGltcG9ydCBcIiR7XG4gICAgICAgICAgICAgICAgc2l0ZS51cmwoXG4gICAgICAgICAgICAgICAgICBgJHtwb3NpeC5qb2luKG9wdGlvbnMub3V0cHV0UGF0aCwgXCJwYWdlZmluZC1oaWdobGlnaHQuanNcIil9YCxcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIH1cIjtcbiAgICAgICAgICAgICAgbmV3IFBhZ2VmaW5kSGlnaGxpZ2h0KHsgaGlnaGxpZ2h0UGFyYW06ICR7XG4gICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodWkuaGlnaGxpZ2h0UGFyYW0pXG4gICAgICAgICAgICAgIH0gfSk7XG4gICAgICAgICAgICAgIGA7XG4gICAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kKGhpZ2hsaWdodFNjcmlwdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBUyxLQUFLLFFBQVEsMEJBQTBCO0FBQ2hELFNBQVMsS0FBSyxRQUFRLGtCQUFrQjtBQUN4QyxTQUFTLElBQUksUUFBUSxrQkFBa0I7QUFDdkMsU0FBUyxRQUFRLFFBQVEsc0JBQXNCO0FBZ0gvQyxPQUFPLE1BQU0sV0FBb0I7RUFDL0IsWUFBWTtFQUNaLElBQUk7SUFDRixhQUFhO0lBQ2IsWUFBWTtJQUNaLGVBQWU7SUFDZixrQkFBa0I7SUFDbEIsZ0JBQWdCO0lBQ2hCLGFBQWE7RUFDZjtFQUNBLFVBQVU7SUFDUixjQUFjO0lBQ2QsU0FBUztJQUNULGtCQUFrQixFQUFFO0VBQ3RCO0FBQ0YsRUFBRTtBQUVGLDBEQUEwRCxHQUMxRCxlQUFlLFNBQVUsV0FBcUI7RUFDNUMsTUFBTSxVQUFVLE1BQU0sVUFBVTtFQUVoQyxPQUFPLENBQUM7SUFDTixLQUFLLE9BQU8sQ0FBQztNQUFDO0tBQVEsRUFBRSxPQUFPLE9BQU87TUFDcEMsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0sU0FBUyxXQUFXLENBQUMsUUFBUSxRQUFRO01BRTdELElBQUksQ0FBQyxPQUFPO1FBQ1YsTUFBTSxJQUFJLE1BQU07TUFDbEI7TUFFQSxnQkFBZ0I7TUFDaEIsS0FBSyxNQUFNLFFBQVEsTUFBTztRQUN4QixNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsTUFBTSxNQUFNLFdBQVcsQ0FBQztVQUN6QyxLQUFLLEtBQUssSUFBSSxDQUFDLEdBQUc7VUFDbEIsU0FBUyxLQUFLLE9BQU87UUFDdkI7UUFFQSxJQUFJLE9BQU8sTUFBTSxHQUFHLEdBQUc7VUFDckIsTUFBTSxJQUFJLE1BQ1IsQ0FBQywwQkFBMEIsRUFBRSxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUV2RTtNQUNGO01BRUEsSUFBSSxRQUFRLGFBQWEsRUFBRTtRQUN6QixLQUFLLE1BQU0sVUFBVSxRQUFRLGFBQWEsQ0FBRTtVQUMxQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsTUFBTSxNQUFNLGVBQWUsQ0FBQztVQUUvQyxJQUFJLE9BQU8sTUFBTSxHQUFHLEdBQUc7WUFDckIsTUFBTSxJQUFJLE1BQ1IsQ0FBQywwQ0FBMEMsRUFBRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7VUFFcEU7UUFDRjtNQUNGO01BRUEsa0JBQWtCO01BQ2xCLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLE1BQU0sUUFBUTtNQUN0QyxNQUFNLGNBQWMsSUFBSTtNQUN4QixNQUFNLGlCQUFpQjtRQUFDO1FBQU87UUFBUTtPQUFRO01BRS9DLEtBQUssTUFBTSxRQUFRLE1BQU87UUFDeEIsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHO1FBQ2pCLE1BQU0sVUFBVSxlQUFlLFFBQVEsQ0FBQyxNQUFNLE9BQU8sQ0FBQyxTQUNsRCxZQUFZLE1BQU0sQ0FBQyxLQUFLLE9BQU8sSUFDL0IsS0FBSyxPQUFPO1FBRWhCLFNBQVMsSUFBSSxDQUNYLEtBQUssTUFBTSxDQUFDO1VBQ1YsS0FBSyxNQUFNLElBQUksQ0FBQyxLQUFLLFFBQVEsVUFBVSxFQUFFO1VBQ3pDO1FBQ0Y7TUFFSjtNQUVBLFVBQVU7TUFDVixNQUFNLE1BQU0sV0FBVztNQUN2QixNQUFNLFNBQVMsS0FBSztJQUN0QjtJQUVBLElBQUksUUFBUSxFQUFFLEVBQUU7TUFDZCxNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsSUFBSSxHQUFHLFFBQVEsRUFBRTtNQUV6QyxLQUFLLE9BQU8sQ0FBQztRQUFDO09BQVEsRUFBRSxDQUFDO1FBQ3ZCLEtBQUssTUFBTSxRQUFRLE1BQU87VUFDeEIsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHO1VBQ3JCLElBQUksQ0FBQyxVQUFVO1lBQ2I7VUFDRjtVQUNBLE1BQU0sWUFBWSxTQUFTLGNBQWMsQ0FBQztVQUUxQywrQkFBK0I7VUFDL0IsSUFBSSxXQUFXO1lBQ2IsTUFBTSxTQUFTLFNBQVMsYUFBYSxDQUFDO1lBQ3RDLE9BQU8sWUFBWSxDQUFDLE9BQU87WUFDM0IsT0FBTyxZQUFZLENBQ2pCLFFBQ0EsS0FBSyxHQUFHLENBQ04sQ0FBQyxFQUFFLE1BQU0sSUFBSSxDQUFDLFFBQVEsVUFBVSxFQUFFLG1CQUFtQixDQUFDO1lBSTFELGlEQUFpRDtZQUNqRCxNQUFNLFFBQVEsU0FBUyxJQUFJLENBQUMsYUFBYSxDQUN2QztZQUVGLElBQUksT0FBTztjQUNULFNBQVMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRO1lBQ3JDLE9BQU87Y0FDTCxTQUFTLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDdkI7WUFFQSxNQUFNLFNBQVMsU0FBUyxhQUFhLENBQUM7WUFDdEMsT0FBTyxZQUFZLENBQUMsUUFBUTtZQUM1QixPQUFPLFlBQVksQ0FDakIsT0FDQSxLQUFLLEdBQUcsQ0FDTixDQUFDLEVBQUUsTUFBTSxJQUFJLENBQUMsUUFBUSxVQUFVLEVBQUUsa0JBQWtCLENBQUM7WUFHekQsU0FBUyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBRXJCLE1BQU0sYUFBYTtjQUNqQixTQUFTLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQztjQUMxQixHQUFHLEVBQUU7Y0FDTCxZQUFZLEtBQUssR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLFFBQVEsVUFBVSxFQUFFO2NBQ3BELFNBQVMsS0FBSyxHQUFHLENBQUM7Y0FDbEIsYUFBYSxHQUFHLFdBQVcsR0FDdkIsR0FBRyxXQUFXLENBQUMsUUFBUSxLQUN2QjtjQUNKLGVBQWUsR0FBRyxhQUFhLEdBQzNCLEdBQUcsYUFBYSxDQUFDLFFBQVEsS0FDekI7WUFDTjtZQUNBLE1BQU0sT0FBTyxTQUFTLGFBQWEsQ0FBQztZQUNwQyxLQUFLLFlBQVksQ0FBQyxRQUFRO1lBQzFCLEtBQUssU0FBUyxHQUNaLENBQUMsK0RBQStELEVBQzlELEtBQUssU0FBUyxDQUFDLFlBQ2hCLEtBQUssQ0FBQztZQUNULFNBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUVyQixJQUFJLEdBQUcsY0FBYyxFQUFFO2NBQ3JCLE1BQU0sa0JBQWtCLFNBQVMsYUFBYSxDQUFDO2NBQy9DLGdCQUFnQixZQUFZLENBQUMsUUFBUTtjQUNyQyxnQkFBZ0IsU0FBUyxHQUFHLENBQUM7c0JBQ3JCLEVBQ04sS0FBSyxHQUFHLENBQ04sQ0FBQyxFQUFFLE1BQU0sSUFBSSxDQUFDLFFBQVEsVUFBVSxFQUFFLHlCQUF5QixDQUFDLEVBRS9EO3NEQUN1QyxFQUN0QyxLQUFLLFNBQVMsQ0FBQyxHQUFHLGNBQWMsRUFDakM7Y0FDRCxDQUFDO2NBQ0QsU0FBUyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQ3ZCO1VBQ0Y7UUFDRjtNQUNGO0lBQ0Y7RUFDRjtBQUNGIn0=